<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chrono</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f5f2eb;
  --paper: #faf8f4;
  --ink: #1a1814;
  --ink2: #3d3a34;
  --muted: #9a9590;
  --border: #e2ddd5;
  --accent: #c17f3e;
  --accent-light: rgba(193,127,62,0.12);
  --red: #c0392b;
}
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 2rem; height: 60px;
  background: var(--paper); border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.logo {
  font-family: 'Playfair Display', serif; font-size: 1.4rem;
  font-weight: 600; letter-spacing: -0.02em;
  display: flex; align-items: center; gap: 0.5rem;
}
.logo-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); }
.header-center { display: flex; align-items: center; gap: 1rem; }
.month-nav { display: flex; align-items: center; gap: 0.75rem; }
.nav-btn {
  background: none; border: 1px solid var(--border); color: var(--ink);
  width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
  font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s;
}
.nav-btn:hover { background: var(--border); }
.month-label {
  font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 600;
  min-width: 190px; text-align: center; letter-spacing: -0.01em;
}
.btn-today {
  background: none; border: 1px solid var(--border); color: var(--ink2);
  padding: 0.3rem 0.9rem; border-radius: 20px;
  font-family: 'DM Sans', sans-serif; font-size: 0.78rem; cursor: pointer;
  transition: background 0.15s;
}
.btn-today:hover { background: var(--border); }
.btn-new {
  background: var(--ink); color: var(--paper); border: none;
  padding: 0.45rem 1.1rem; border-radius: 6px;
  font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 500;
  cursor: pointer; transition: opacity 0.15s;
}
.btn-new:hover { opacity: 0.8; }

.app-body { display: flex; flex: 1; overflow: hidden; }

/* SIDEBAR */
.sidebar {
  width: 260px; flex-shrink: 0;
  border-right: 1px solid var(--border);
  background: var(--paper);
  display: flex; flex-direction: column; overflow: hidden;
}
.mini-cal { padding: 1.25rem; border-bottom: 1px solid var(--border); }
.mini-cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
.mini-month { font-family: 'DM Mono', monospace; font-size: 0.68rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--ink2); }
.mini-nav { display: flex; gap: 4px; }
.mini-nav-btn { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 0.75rem; padding: 2px 5px; transition: color 0.15s; }
.mini-nav-btn:hover { color: var(--ink); }
.mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
.mini-dow { font-family: 'DM Mono', monospace; font-size: 0.58rem; color: var(--muted); text-align: center; padding: 2px 0 5px; }
.mini-day {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; border-radius: 50%; cursor: pointer; color: var(--ink2);
  transition: background 0.1s; position: relative;
}
.mini-day:hover { background: var(--border); }
.mini-day.other-month { color: var(--muted); opacity: 0.35; }
.mini-day.today { background: var(--ink); color: var(--paper); font-weight: 500; }
.mini-day.selected { outline: 2px solid var(--accent); }
.mini-day.has-event::after {
  content: ''; position: absolute; bottom: 1px;
  width: 3px; height: 3px; border-radius: 50%; background: var(--accent);
}
.mini-day.today.has-event::after { background: var(--paper); }

.upcoming { flex: 1; overflow-y: auto; padding: 1rem 1.25rem; }
.upcoming::-webkit-scrollbar { width: 3px; }
.upcoming::-webkit-scrollbar-thumb { background: var(--border); }
.upcoming-title { font-family: 'DM Mono', monospace; font-size: 0.63rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; }
.upcoming-item {
  display: flex; gap: 0.75rem; padding: 0.65rem 0;
  border-bottom: 1px solid var(--border); cursor: pointer; transition: opacity 0.15s;
}
.upcoming-item:hover { opacity: 0.65; }
.upcoming-item:last-child { border-bottom: none; }
.up-stripe { width: 3px; border-radius: 2px; flex-shrink: 0; align-self: stretch; }
.up-info { flex: 1; min-width: 0; }
.up-name { font-size: 0.82rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.15rem; }
.up-date { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--muted); }
.up-delete { background: none; border: none; color: var(--border); cursor: pointer; font-size: 0.82rem; opacity: 0; transition: opacity 0.15s, color 0.15s; padding: 0; align-self: center; }
.upcoming-item:hover .up-delete { opacity: 1; }
.up-delete:hover { color: var(--red); }
.no-events { text-align: center; padding: 2rem 0; color: var(--muted); font-size: 0.82rem; }

/* MAIN CALENDAR */
.cal-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.dow-header { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.dow-label { font-family: 'DM Mono', monospace; font-size: 0.65rem; letter-spacing: 0.07em; text-transform: uppercase; color: var(--muted); text-align: center; padding: 0.6rem 0; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(6, 1fr); flex: 1; overflow: hidden; }
.cal-cell {
  border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
  padding: 6px; overflow: hidden; cursor: pointer; transition: background 0.1s;
}
.cal-cell:hover { background: rgba(26,24,20,0.025); }
.cal-cell:nth-child(7n) { border-right: none; }
.cal-cell.other-month { opacity: 0.3; }
.cal-cell.today .cell-num { background: var(--ink); color: var(--paper); }
.cal-cell.selected { background: var(--accent-light); }
.cell-num {
  font-size: 0.75rem; font-weight: 500; width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%; margin-bottom: 3px; font-family: 'DM Mono', monospace;
}
.cell-events { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
.cell-event {
  font-size: 0.66rem; padding: 1px 5px; border-radius: 3px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  font-weight: 500; line-height: 1.5;
}
.cell-more { font-size: 0.63rem; color: var(--muted); font-family: 'DM Mono', monospace; padding: 1px 3px; }

/* DAY PANEL */
.day-panel {
  position: fixed; right: 0; top: 60px; bottom: 0; width: 290px;
  background: var(--paper); border-left: 1px solid var(--border);
  transform: translateX(100%); transition: transform 0.25s ease;
  z-index: 100; overflow-y: auto; padding: 1.5rem;
}
.day-panel.open { transform: translateX(0); }
.day-panel-date { font-family: 'Playfair Display', serif; font-size: 1.2rem; margin-bottom: 1rem; padding-right: 2rem; }
.day-panel-event {
  background: var(--bg); border-radius: 8px; padding: 0.85rem;
  margin-bottom: 0.5rem; border-left: 3px solid transparent;
  display: flex; justify-content: space-between; align-items: flex-start;
}
.dpe-info { flex: 1; }
.dpe-name { font-size: 0.88rem; font-weight: 500; margin-bottom: 0.2rem; }
.dpe-meta { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--muted); }
.dpe-delete { background: none; border: none; color: var(--border); cursor: pointer; font-size: 0.85rem; transition: color 0.15s; padding: 0; }
.dpe-delete:hover { color: var(--red); }
.panel-close { position: absolute; top: 1.25rem; right: 1.25rem; background: none; border: none; color: var(--muted); font-size: 1rem; cursor: pointer; }
.panel-close:hover { color: var(--ink); }
.btn-add-day { width: 100%; margin-top: 1rem; padding: 0.6rem; background: var(--bg); border: 1px dashed var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; color: var(--muted); cursor: pointer; transition: border-color 0.15s, color 0.15s; }
.btn-add-day:hover { border-color: var(--accent); color: var(--accent); }

/* MODAL */
.overlay {
  position: fixed; inset: 0; background: rgba(26,24,20,0.4); backdrop-filter: blur(4px);
  z-index: 200; display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--paper); border-radius: 14px; width: 420px; max-width: 95vw;
  box-shadow: 0 20px 60px rgba(26,24,20,0.18);
  transform: translateY(16px) scale(0.98); transition: transform 0.25s ease; overflow: hidden;
}
.overlay.open .modal { transform: translateY(0) scale(1); }
.modal-head { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-head h3 { font-family: 'Playfair Display', serif; font-size: 1.15rem; }
.btn-x { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; transition: color 0.15s; }
.btn-x:hover { color: var(--ink); }
.modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
.mf label { display: block; font-family: 'DM Mono', monospace; font-size: 0.63rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.35rem; }
.mf input, .mf select {
  width: 100%; padding: 0.65rem 0.85rem; border: 1px solid var(--border);
  border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
  color: var(--ink); background: var(--bg); outline: none; transition: border-color 0.2s;
}
.mf input:focus, .mf select:focus { border-color: var(--accent); }
.mf input::placeholder { color: var(--muted); }
.mrow { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
.color-picker { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.color-swatch { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.1s, border-color 0.1s; }
.color-swatch:hover { transform: scale(1.15); }
.color-swatch.selected { border-color: var(--ink); transform: scale(1.1); }
.modal-foot { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }
.btn-cancel { background: none; border: 1px solid var(--border); color: var(--ink2); padding: 0.6rem 1.25rem; border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; transition: background 0.15s; }
.btn-cancel:hover { background: var(--border); }
.btn-save { background: var(--ink); color: var(--paper); border: none; padding: 0.6rem 1.5rem; border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: opacity 0.15s; }
.btn-save:hover { opacity: 0.8; }

.toast {
  position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(80px);
  background: var(--ink); color: var(--paper); padding: 0.7rem 1.4rem; border-radius: 8px;
  font-size: 0.82rem; z-index: 400; opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
</style>
</head>
<body>

<header class="header">
  <div class="logo"><div class="logo-dot"></div>Chrono</div>
  <div class="header-center">
    <div class="month-nav">
      <button class="nav-btn" onclick="changeMonth(-1)">â€¹</button>
      <div class="month-label" id="monthLabel"></div>
      <button class="nav-btn" onclick="changeMonth(1)">â€º</button>
    </div>
    <button class="btn-today" onclick="goToday()">Today</button>
  </div>
  <button class="btn-new" onclick="openModal()">+ New Event</button>
</header>

<div class="app-body">
  <div class="sidebar">
    <div class="mini-cal">
      <div class="mini-cal-header">
        <span class="mini-month" id="miniMonthLabel"></span>
        <div class="mini-nav">
          <button class="mini-nav-btn" onclick="changeMonth(-1)">â€¹</button>
          <button class="mini-nav-btn" onclick="changeMonth(1)">â€º</button>
        </div>
      </div>
      <div class="mini-grid" id="miniGrid"></div>
    </div>
    <div class="upcoming">
      <div class="upcoming-title">Upcoming</div>
      <div id="upcomingList"></div>
    </div>
  </div>

  <div class="cal-main">
    <div class="dow-header">
      <div class="dow-label">Sun</div><div class="dow-label">Mon</div>
      <div class="dow-label">Tue</div><div class="dow-label">Wed</div>
      <div class="dow-label">Thu</div><div class="dow-label">Fri</div>
      <div class="dow-label">Sat</div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>
</div>

<div class="day-panel" id="dayPanel">
  <button class="panel-close" onclick="closePanel()">âœ•</button>
  <div class="day-panel-date" id="panelDate"></div>
  <div id="panelEvents"></div>
  <button class="btn-add-day" onclick="openModal(selectedDate)">+ Add event this day</button>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-head">
      <h3>New Event</h3>
      <button class="btn-x" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="mf">
        <label>Title *</label>
        <input type="text" id="newTitle" placeholder="Meeting, birthday, appointment...">
      </div>
      <div class="mrow">
        <div class="mf">
          <label>Date *</label>
          <input type="date" id="newDate">
        </div>
        <div class="mf">
          <label>Time</label>
          <input type="time" id="newTime" value="09:00">
        </div>
      </div>
      <div class="mf">
        <label>Email reminder</label>
        <select id="newReminder">
          <option value="1">1 hour before</option>
          <option value="2">2 hours before</option>
          <option value="6">6 hours before</option>
          <option value="24" selected>24 hours before</option>
          <option value="48">48 hours before</option>
        </select>
      </div>
      <div class="mf">
        <label>Notes</label>
        <input type="text" id="newNotes" placeholder="Zoom link, location, prep...">
      </div>
      <div class="mf">
        <label>Color</label>
        <div class="color-picker" id="colorPicker">
          <div class="color-swatch selected" data-color="#c17f3e" style="background:#c17f3e" title="Amber"></div>
          <div class="color-swatch" data-color="#c0392b" style="background:#c0392b" title="Red"></div>
          <div class="color-swatch" data-color="#27ae60" style="background:#27ae60" title="Green"></div>
          <div class="color-swatch" data-color="#2980b9" style="background:#2980b9" title="Blue"></div>
          <div class="color-swatch" data-color="#8e44ad" style="background:#8e44ad" title="Purple"></div>
          <div class="color-swatch" data-color="#16a085" style="background:#16a085" title="Teal"></div>
          <div class="color-swatch" data-color="#1a1814" style="background:#1a1814" title="Black"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="addEvent()">Save Event</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = 'https://chrono-calendar-production.up.railway.app';
let events = [];
let currentYear, currentMonth;
let selectedDate = null;
let selectedColor = '#c17f3e';

const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTH_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

document.querySelectorAll('.color-swatch').forEach(s => {
  s.addEventListener('click', () => {
    document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('selected'));
    s.classList.add('selected');
    selectedColor = s.dataset.color;
  });
});

async function loadEvents() {
  try {
    const res = await fetch(`${API}/events`);
    events = await res.json();
    renderAll();
  } catch(e) { showToast('Could not reach backend'); }
}

function init() {
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();
  loadEvents();
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  renderAll();
}

function goToday() {
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();
  renderAll();
}

function toDateStr(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function eventsOnDate(dateStr) {
  return events.filter(e => e.datetime && e.datetime.startsWith(dateStr));
}

function hexToRgba(hex, alpha) {
  if (!hex || hex.length < 7) return `rgba(193,127,62,${alpha})`;
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function buildCalCells(year, month) {
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const cells = [];
  for (let i = 0; i < 42; i++) {
    let day, m, y, isOther = false;
    if (i < firstDay) {
      day = daysInPrev - firstDay + i + 1; m = month - 1; y = year;
      if (m < 0) { m = 11; y--; } isOther = true;
    } else if (i - firstDay >= daysInMonth) {
      day = i - firstDay - daysInMonth + 1; m = month + 1; y = year;
      if (m > 11) { m = 0; y++; } isOther = true;
    } else {
      day = i - firstDay + 1; m = month; y = year;
    }
    cells.push({ day, month: m, year: y, isOther, dateStr: toDateStr(y, m, day) });
  }
  return cells;
}

function renderAll() {
  renderMainCal();
  renderMiniCal();
  renderUpcoming();
  if (selectedDate && document.getElementById('dayPanel').classList.contains('open')) {
    renderDayPanel(selectedDate);
  }
}

function renderMainCal() {
  document.getElementById('monthLabel').textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  const today = new Date();
  const todayStr = toDateStr(today.getFullYear(), today.getMonth(), today.getDate());

  buildCalCells(currentYear, currentMonth).forEach(({ day, isOther, dateStr }) => {
    const cell = document.createElement('div');
    cell.className = 'cal-cell' + (isOther ? ' other-month' : '') + (dateStr === todayStr ? ' today' : '') + (dateStr === selectedDate ? ' selected' : '');

    const numEl = document.createElement('div');
    numEl.className = 'cell-num';
    numEl.textContent = day;
    cell.appendChild(numEl);

    const dayEvents = eventsOnDate(dateStr);
    if (dayEvents.length) {
      const ec = document.createElement('div');
      ec.className = 'cell-events';
      const max = 3;
      dayEvents.slice(0, max).forEach(ev => {
        const pill = document.createElement('div');
        pill.className = 'cell-event';
        const d = new Date(ev.datetime);
        const t = d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
        pill.textContent = t + ' ' + ev.title;
        pill.style.background = hexToRgba(ev.color, 0.15);
        pill.style.color = ev.color || '#c17f3e';
        ec.appendChild(pill);
      });
      if (dayEvents.length > max) {
        const more = document.createElement('div');
        more.className = 'cell-more';
        more.textContent = `+${dayEvents.length - max} more`;
        ec.appendChild(more);
      }
      cell.appendChild(ec);
    }

    cell.addEventListener('click', () => selectDate(dateStr));
    grid.appendChild(cell);
  });
}

function renderMiniCal() {
  document.getElementById('miniMonthLabel').textContent = `${MONTH_SHORT[currentMonth]} ${currentYear}`;
  const grid = document.getElementById('miniGrid');
  grid.innerHTML = '';
  ['S','M','T','W','T','F','S'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'mini-dow'; el.textContent = d; grid.appendChild(el);
  });
  const today = new Date();
  const todayStr = toDateStr(today.getFullYear(), today.getMonth(), today.getDate());
  buildCalCells(currentYear, currentMonth).forEach(({ day, isOther, dateStr }) => {
    const el = document.createElement('div');
    el.className = 'mini-day'
      + (isOther ? ' other-month' : '')
      + (dateStr === todayStr ? ' today' : '')
      + (dateStr === selectedDate ? ' selected' : '')
      + (eventsOnDate(dateStr).length ? ' has-event' : '');
    el.textContent = day;
    el.addEventListener('click', () => selectDate(dateStr));
    grid.appendChild(el);
  });
}

function renderUpcoming() {
  const list = document.getElementById('upcomingList');
  const now = new Date();
  const upcoming = events
    .filter(e => new Date(e.datetime) >= now)
    .sort((a,b) => new Date(a.datetime) - new Date(b.datetime))
    .slice(0, 10);

  if (!upcoming.length) {
    list.innerHTML = '<div class="no-events">No upcoming events</div>'; return;
  }
  list.innerHTML = upcoming.map(ev => {
    const d = new Date(ev.datetime);
    return `<div class="upcoming-item" onclick="selectDate('${ev.datetime.slice(0,10)}')">
      <div class="up-stripe" style="background:${ev.color||'#c17f3e'}"></div>
      <div class="up-info">
        <div class="up-name">${ev.title}</div>
        <div class="up-date">${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})} Â· ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <button class="up-delete" onclick="event.stopPropagation();removeEvent(${ev.id})">âœ•</button>
    </div>`;
  }).join('');
}

function selectDate(dateStr) {
  selectedDate = dateStr;
  renderAll();
  renderDayPanel(dateStr);
  document.getElementById('dayPanel').classList.add('open');
}

function closePanel() {
  document.getElementById('dayPanel').classList.remove('open');
  selectedDate = null;
  renderAll();
}

function renderDayPanel(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  document.getElementById('panelDate').textContent =
    d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const dayEvs = eventsOnDate(dateStr).sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
  const c = document.getElementById('panelEvents');
  if (!dayEvs.length) {
    c.innerHTML = '<div class="no-events" style="padding:1.5rem 0">No events this day</div>'; return;
  }
  c.innerHTML = dayEvs.map(ev => {
    const t = new Date(ev.datetime).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    return `<div class="day-panel-event" style="border-left-color:${ev.color||'#c17f3e'}">
      <div class="dpe-info">
        <div class="dpe-name">${ev.title}</div>
        <div class="dpe-meta">${t}${ev.notes ? ' Â· ' + ev.notes : ''}</div>
        <div class="dpe-meta" style="margin-top:3px">ðŸ”” ${ev.reminderHours}h before</div>
      </div>
      <button class="dpe-delete" onclick="removeEvent(${ev.id})">âœ•</button>
    </div>`;
  }).join('');
}

function openModal(prefillDate) {
  const now = new Date();
  const fallback = toDateStr(now.getFullYear(), now.getMonth(), now.getDate());
  document.getElementById('newDate').value = prefillDate || selectedDate || fallback;
  document.getElementById('overlay').classList.add('open');
  setTimeout(() => document.getElementById('newTitle').focus(), 50);
}

function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('newTitle').value = '';
  document.getElementById('newNotes').value = '';
  document.getElementById('newTime').value = '09:00';
}

async function addEvent() {
  const title = document.getElementById('newTitle').value.trim();
  const date = document.getElementById('newDate').value;
  const time = document.getElementById('newTime').value || '09:00';
  if (!title || !date) { showToast('Please add a title and date'); return; }

  const ev = {
    title,
    datetime: `${date}T${time}`,
    reminderHours: parseInt(document.getElementById('newReminder').value),
    notes: document.getElementById('newNotes').value.trim(),
    color: selectedColor,
  };

  try {
    const res = await fetch(`${API}/events`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(ev)
    });
    const saved = await res.json();
    events.push(saved);
    closeModal();
    renderAll();
    selectDate(date);
    showToast(`"${title}" saved âœ“`);
  } catch(e) { showToast('Failed to save â€” check backend'); }
}

async function removeEvent(id) {
  try {
    await fetch(`${API}/events/${id}`, { method: 'DELETE' });
    events = events.filter(e => e.id !== id);
    renderAll();
    if (selectedDate) renderDayPanel(selectedDate);
    showToast('Event removed');
  } catch(e) { showToast('Failed to delete'); }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

document.getElementById('overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

init();
</script>
</body>
</html>
